[tools]
go = "1.23"
node = "22"
bun = "1"

[tasks.dev-frontend]
description = "Start Vite dev server with HMR"
dir = "web"
run = "bun run dev"

[tasks."generate:embed-stub"]
description = "Ensure embed dist stub exists for go build"
run = 'mkdir -p internal/embed/dist && [ -f internal/embed/dist/index.html ] || echo "<!DOCTYPE html><html><body><p>peel â€” run mise run build</p></body></html>" > internal/embed/dist/index.html'
hide = true

[tasks.dev-backend]
description = "Start Go backend in dev mode"
depends = ["generate:embed-stub"]
run = "go run ./cmd/peel --no-open"

[tasks.build]
description = "Build single binary with embedded frontend"
run = """
cd web && bun run build && cd .. && rm -rf internal/embed/dist && cp -r web/dist internal/embed/dist && go build -o peel ./cmd/peel
"""
depends = ["generate:embed-stub"]

[tasks.check]
description = "Typecheck Go and TypeScript"
depends = ["generate:embed-stub"]
run = "go vet ./... && cd web && bunx tsc --noEmit"

[tasks.clean]
description = "Remove build artifacts"
run = "rm -f peel && rm -rf web/dist internal/embed/dist"
